# 药品与库存后端接口需求

## 概述

- 目标：为“药品与库存”模块（库存与批次、入出库日志、处方状态流转、供应商与采购订单）提供稳定、可扩展的后端接口，所有数据来自数据库，所有写操作实时更新数据库并保持一致性。
- 依据：当前前端接口与数据结构（参见 `omms_frontend/src/api/pharmacy.js`，以及页面 `omms_frontend/src/views/PharmacyManagement.vue` 与相关组件），需要后端落地为真实服务。

## 统一响应规范

- 统一包：`{ code: number, message: string, data?: any }`
- 成功：`code=200`；客户端依据 `data` 消费
- 客户端可感知的错误：`400` 参数错误，`404` 资源不存在，`409` 业务冲突，`401/403` 认证或权限不足

## 资源模型

- Medicine（药品）：
  - `{ id: number, name: string, specification: string, unit: string, price: number, currentStock: number, warningStock: number }`
- InventoryBatch（库存批次）：
  - `{ id: number, batchNo: string, medicineId: number, quantity: number, receivedAt: 'YYYY-MM-DD', expiryDate: 'YYYY-MM-DD' }`
- InventoryLog（入出库日志）：
  - `{ id: number, type: 'in'|'out', medicineId: number, quantity: number, time: 'YYYY-MM-DD HH:mm', note?: string, batchNo?: string }`
- Prescription（处方，药房侧查看与流转）：
  - `{ id: string, patient: string, department: string, doctor: string, createdAt: 'YYYY-MM-DD HH:mm', status: 'pending'|'approved'|'dispensed', items: Array<{ medicineId: number, name?: string, qty: number, unit: string, price: number }> }`
- Supplier（供应商）：
  - `{ id: number, name: string, contact?: string, phone?: string, address?: string }`
- SupplierOrder（采购订单）：
  - `{ id: string, supplierId: number, createdAt: 'YYYY-MM-DD HH:mm', status: 'pending'|'completed'|'cancelled', amount: number, items: Array<{ medicineId: number, name?: string, qty: number, unit: string, price?: number }> }`

> 说明：ID 与编码规范可遵循：处方 `RX-YYYYMMDD-XXXX`，采购订单 `PO-YYYYMMDD-XXXX`。

## 接口详情

### 药品与库存

- GET `/api/pharmacy/medicines`
  - 描述：药品列表查询
  - 查询参数：`keyword?: string`，`lowStockOnly?: boolean`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: Medicine[], total: number, page: number, pageSize: number }`
- GET `/api/pharmacy/medicines/{id}`
  - 描述：药品详情
  - 响应：`Medicine`
- POST `/api/pharmacy/medicines`
  - 描述：创建药品
  - 请求体：`{ name: string, specification: string, unit: string, price: number, warningStock?: number }`
  - 行为：初始化 `currentStock=0`；创建成功写入 DB
  - 响应：`Medicine`
- PUT `/api/pharmacy/medicines/{id}`
  - 描述：更新药品信息（不含库存数量）
  - 请求体：`{ name?: string, specification?: string, unit?: string, price?: number, warningStock?: number }`
  - 响应：`Medicine`
- DELETE `/api/pharmacy/medicines/{id}`（可选）
  - 描述：删除药品；若存在库存/订单引用则返回 `409`

- GET `/api/pharmacy/inventory/batches`
  - 描述：库存批次列表
  - 查询参数：`medicineId?: number`，`expiringInDays?: number`（如 `30`）
  - 响应：`InventoryBatch[]`
- GET `/api/pharmacy/inventory/logs`
  - 描述：入出库日志列表
  - 查询参数：`type?: 'in'|'out'`，`medicineId?: number`，`dateFrom?: string`，`dateTo?: string`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: InventoryLog[], total: number, page: number, pageSize: number }`

- POST `/api/pharmacy/inventory/in`
  - 描述：入库（创建批次与日志，并增加对应药品的 `currentStock`）
  - 请求体：`{ medicineId: number, batchNo: string, quantity: number, receivedAt: 'YYYY-MM-DD', expiryDate?: 'YYYY-MM-DD', note?: string }`
  - 行为：
    - 创建 `InventoryBatch`
    - 写入 `InventoryLog(type='in')`
    - 累加 `Medicine.currentStock += quantity`
  - 响应：`{ batch: InventoryBatch, log: InventoryLog, medicine: Medicine }`

- POST `/api/pharmacy/inventory/out`
  - 描述：出库（写入日志，并扣减对应药品的 `currentStock`）
  - 请求体：`{ medicineId: number, quantity: number, time?: 'YYYY-MM-DD HH:mm', note?: string }`
  - 行为：
    - 校验库存充足
    - 写入 `InventoryLog(type='out')`
    - 扣减 `Medicine.currentStock -= quantity`
  - 响应：`{ log: InventoryLog, medicine: Medicine }`

### 处方（药房侧）

- GET `/api/pharmacy/prescriptions`
  - 描述：处方列表查询
  - 查询参数：`status?: 'pending'|'approved'|'dispensed'`，`date?: 'YYYY-MM-DD'`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: Prescription[], total: number, page: number, pageSize: number }`
- GET `/api/pharmacy/prescriptions/{id}`
  - 描述：处方详情
  - 响应：`Prescription`
- PATCH `/api/pharmacy/prescriptions/{id}/status`
  - 描述：更新处方状态
  - 请求体：`{ status: 'approved'|'dispensed' }`
  - 约束：
    - 合法状态流转：`pending -> approved -> dispensed`
    - `approved` 时仅状态变更，不改库存；`dispensed` 时须扣减库存（据处方明细），并写入出库日志：
      - 对处方 `items` 中每个 `{ medicineId, qty }`：执行库存扣减与日志写入（同 `/inventory/out` 的行为）
  - 响应：更新后的 `Prescription`

### 供应商与采购订单

- GET `/api/pharmacy/suppliers`
  - 描述：供应商列表
  - 查询参数：`keyword?: string`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: Supplier[], total: number, page: number, pageSize: number }`
- GET `/api/pharmacy/suppliers/{id}`
  - 描述：供应商详情
  - 响应：`Supplier`
- POST `/api/pharmacy/suppliers`
  - 描述：创建供应商
  - 请求体：`{ name: string, contact?: string, phone?: string, address?: string }`
  - 校验：`name` 去空格后不可为空；`phone` 可选但须符合格式
  - 响应：`Supplier`
- PUT `/api/pharmacy/suppliers/{id}`
  - 描述：更新供应商信息
  - 请求体：`{ name?: string, contact?: string, phone?: string, address?: string }`
  - 响应：`Supplier`
- DELETE `/api/pharmacy/suppliers/{id}`（可选）
  - 描述：删除供应商；若存在未完成采购订单返回 `409`

- GET `/api/pharmacy/orders`
  - 描述：采购订单列表
  - 查询参数：`status?: 'pending'|'completed'|'cancelled'`，`supplierId?: number`，`dateFrom?: string`，`dateTo?: string`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: SupplierOrder[], total: number, page: number, pageSize: number }`
- GET `/api/pharmacy/orders/{id}`
  - 描述：订单详情
  - 响应：`SupplierOrder`
- POST `/api/pharmacy/orders`
  - 描述：创建采购订单
  - 请求体：`{ supplierId: number, items: Array<{ medicineId: number, qty: number, unit: string, price?: number }> }`
  - 行为：
    - 生成订单号 `PO-YYYYMMDD-XXXX`
    - 计算 `amount = Σ(items.qty * items.price)`（若 `price` 缺失可从药品价目取值）
    - 初始 `status='pending'`
  - 响应：`SupplierOrder`
- PATCH `/api/pharmacy/orders/{id}/status`
  - 描述：更新订单状态
  - 请求体：`{ status: 'completed'|'cancelled' }`
  - 约束：
    - 合法状态值；`pending -> completed|cancelled`
    - 当置为 `completed`：执行入库（将订单 `items` 入库为批次并写入日志），与 `/inventory/in` 行为一致，可按订单生成统一批次号或逐药品生成批次：
      - 为每个 `{ medicineId, qty }` 创建 `InventoryBatch`（可选批次号约定：`B-订单号-药品ID`），写入 `InventoryLog(type='in')`，累加库存
  - 响应：更新后的 `SupplierOrder`

## 校验与业务约束

- 数据一致性：
  - `InventoryBatch.medicineId` 与 `InventoryLog.medicineId` 必须存在对应 `Medicine`
  - 采购订单 `items.medicineId` 必须存在对应 `Medicine`
- 数量与库存：
  - 出库时库存充足性校验，若不足返回 `400`
  - 入库数量需为正整数
- 价格与金额：
  - 药品价格为非负的两位小数；订单金额为各项乘积之和
- 状态机：
  - 处方：`pending -> approved -> dispensed`
  - 订单：`pending -> completed|cancelled`（完成后不可回退）
- 时间约束：
  - 批次 `expiryDate >= receivedAt`
  - 日志 `time` 不得晚于当前服务器时间
- 审计：所有关键写操作记录操作者 ID、IP、时间与关键字段快照

## 错误码与消息

- `200` 成功
- `400` 参数错误（字段缺失、格式非法、库存不足等）
- `404` 资源不存在（药品/批次/日志/订单/供应商/处方未找到）
- `409` 业务冲突（删除存在引用的资源、非法状态流转等）
- `401/403` 认证失败或权限不足

## 安全与权限

- 认证：建议使用 JWT；所有接口置于受保护路由
- 权限：
  - 药品与库存：药房管理员、仓库人员可入出库与维护药品信息
  - 处方流转：药师可审核与发药；医生仅查看
  - 供应商与采购订单：药房管理员可创建与完成订单
- 审计：关键操作需审计日志与变更快照

## 性能与可靠性要求

- 基线：单实例 `P95 < 400ms`
- 分页：列表接口默认分页，`pageSize` 建议 20–50
- 并发：入出库建议使用乐观锁或库存版本号，避免竞态导致库存不一致
- 指标：暴露低库存数量、近效期批次数、待审核/已审核/已发药处方数、订单状态分布

## 示例载荷

- 入库请求：
  - `{ "medicineId": 101, "batchNo": "B-20250102-0001", "quantity": 200, "receivedAt": "2025-01-02", "expiryDate": "2026-01-02", "note": "到货批次" }`
- 出库请求：
  - `{ "medicineId": 101, "quantity": 5, "time": "2025-01-03 10:00", "note": "处方发药" }`
- 更新处方状态（发药）：
  - `{ "status": "dispensed" }`
- 创建供应商：
  - `{ "name": "华康药业", "contact": "刘女士", "phone": "010-12345678", "address": "北京市昌平区科技园" }`
- 创建采购订单：
  - `{ "supplierId": 1, "items": [ { "medicineId": 101, "qty": 100, "unit": "盒", "price": 12.8 }, { "medicineId": 106, "qty": 200, "unit": "盒", "price": 35.0 } ] }`
