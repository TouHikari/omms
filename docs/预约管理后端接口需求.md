# 预约管理后端接口需求

## 概述

- 目标：为“预约管理”模块提供稳定、可扩展的后端接口，支撑科室、医生、排班与预约的完整流程。
- 依据：当前前端模拟接口与数据结构，需后端落地为真实服务。

## 统一响应规范

- 统一包：`{ code: number, message: string, data?: any }`
- 成功：`code=200`；客户端依据 `data` 消费
- 客户端可感知的错误：`400` 参数错误，`404` 资源不存在，`409` 业务冲突（如超额预约），`401/403` 认证或权限不足

## 资源模型

- Department（科室）：`{ id: number, name: string, description?: string }`
- Doctor（医生）：`{ id: number, name: string, deptId: number, title?: string, specialty?: string, available: boolean }`
- Schedule（排班）：`{ id: number, doctorId: number, date: 'YYYY-MM-DD', startTime: 'HH:mm', endTime: 'HH:mm', maxAppointments: number, booked: number }`
- Appointment（预约）：`{ id: string, patient?: string, department: string, doctor: string, time: 'YYYY-MM-DD HH:mm', status: 'pending'|'completed'|'cancelled', symptom?: string }`
- 预约号规范：`R-YYYYMMDD-XXXX`（四位随机数，参考 `omms_frontend/src/api/appointment.js:69`）

## 接口详情

### 科室管理

- GET `/api/departments`
  - 描述：查询科室列表
  - 响应：`Department[]`
- POST `/api/departments`
  - 描述：创建科室
  - 请求体：`{ name: string, description?: string }`
  - 校验：`name` 去空格后不可为空且唯一
  - 响应：`Department`
- PUT `/api/departments/{id}`
  - 描述：更新科室
  - 请求体：`{ name?: string, description?: string }`
  - 响应：更新后的 `Department`
- DELETE `/api/departments/{id}`
  - 描述：删除科室
  - 约束：若存在医生或排班引用应拒绝并返回 `409`
  - 响应：被删除的 `Department`

### 医生管理

- GET `/api/doctors`
  - 描述：查询医生列表，支持按科室过滤
  - 查询参数：`deptId?: number`
  - 响应：`Doctor[]`
- POST `/api/doctors`
  - 描述：创建医生
  - 请求体：`{ name: string, deptId: number, title?: string, specialty?: string, available?: boolean }`
  - 校验：`deptId` 必填且存在；`name` 去空格后不可为空
  - 响应：`Doctor`
- PUT `/api/doctors/{id}`
  - 描述：更新医生基本信息与可用状态
  - 请求体：`{ name?: string, deptId?: number, title?: string, specialty?: string, available?: boolean }`
  - 响应：更新后的 `Doctor`
- DELETE `/api/doctors/{id}`
  - 描述：删除医生
  - 约束：若存在排班或预约引用应拒绝并返回 `409`
  - 响应：被删除的 `Doctor`

### 排班查询

- GET `/api/schedules`
  - 描述：按医生与日期查询排班
  - 查询参数：`doctorId: number`，`date?: 'YYYY-MM-DD'`
  - 响应：`Schedule[]`
- 说明：接口与前端 `getDoctorSchedules` 功能对齐（`omms_frontend/src/api/appointment.js:30`），支持灵活过滤

### 预约管理

- GET `/api/appointments`
  - 描述：预约列表查询
  - 查询参数：`status?: 'pending'|'completed'|'cancelled'`，`date?: 'YYYY-MM-DD'`，`deptId?: number`，`doctorId?: number`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: Appointment[], total: number, page: number, pageSize: number }`
- POST `/api/appointments`
  - 描述：创建预约
  - 请求体：`{ deptId: number, doctorId: number, scheduleId: number, patientId?: number, patientName?: string, symptom?: string }`
  - 行为：
    - 根据 `scheduleId` 解析 `date/startTime` 生成 `time`
    - 生成预约号 `id`（`R-YYYYMMDD-XXXX`）
    - 增加对应排班的 `booked` 计数
  - 校验：
    - `deptId/doctorId/scheduleId` 必填且一致（医生属于科室，排班属于医生）
    - 排班容量：`booked < maxAppointments`，否则返回 `409`
  - 响应：创建成功的 `Appointment`
- PATCH `/api/appointments/{id}/status`
  - 描述：更新预约状态
  - 请求体：`{ status: 'pending'|'completed'|'cancelled' }`
  - 约束：
    - 仅允许合法状态值
    - 若从 `pending` 更新为 `cancelled` 可选择回滚排班 `booked` 计数（可配置）
  - 响应：更新后的 `Appointment`
- 可选：DELETE `/api/appointments/{id}`
  - 描述：取消预约（与 PATCH 等效，状态置为 `cancelled`）
  - 响应：被取消的 `Appointment`

## 校验与业务约束

- 身份校验：`patientId` 建议使用患者唯一标识，若仅有姓名则记录于 `patientName`
- 一致性校验：`doctor.deptId === deptId`，`schedule.doctorId === doctorId`
- 容量约束：`booked < maxAppointments`，并发下需使用事务或分布式锁防止超卖
- 状态机约束：`pending -> completed|cancelled`；`completed/cancelled` 不可回到 `pending`
- 时间约束：`time` 不能早于当前时间（若业务需要可允许当日剩余时段）

## 错误码与消息

- `200` 成功
- `400` 参数错误（字段缺失、格式非法、状态值不合法）
- `404` 资源不存在（科室/医生/排班/预约未找到）
- `409` 业务冲突（排班容量不足、删除存在引用的资源）
- `401/403` 认证失败或权限不足

## 安全与权限

- 认证：建议使用 JWT；接口需在受保护路由下
- 权限：
  - 科室/医生增删改：管理员或科室主任角色
  - 排班维护：医生或科室排班管理员
  - 预约创建与状态更新：挂号/前台角色，医生可将 `pending` 置为 `completed`
- 审计：记录创建/更新/删除的操作者 ID、IP、时间与变更前后快照（关键字段）

## 性能与可靠性要求

- 基线：单实例 `P95 < 400ms`，并发预约场景下保证无超卖
- 分页：`GET /api/appointments` 默认分页，`pageSize` 建议 20–50
- 指标：暴露排班容量利用率、预约各状态占比、科室/医生当日预约量

## 示例载荷

- 创建预约请求：
  - `{ "deptId": 1, "doctorId": 1, "scheduleId": 2, "patientId": 10086, "symptom": "发热伴咳嗽3天" }`
- 创建预约响应：
  - `{ "code": 200, "message": "success", "data": { "id": "R-20250102-1234", "patient": "王小明", "department": "内科", "doctor": "张医生", "time": "2025-01-02 14:00", "status": "pending", "symptom": "发热伴咳嗽3天" } }`
