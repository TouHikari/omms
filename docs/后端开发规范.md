# OMMS 后端开发规范

本文档旨在统一 OMMS 后端开发风格，确保代码的可读性、可维护性及扩展性。所有后端开发人员在进行代码贡献时，请务必遵循以下规范。

## 1. 技术栈概览

- **Web 框架**: [FastAPI](https://fastapi.tiangolo.com/) (Python 3.9+)
- **ORM 框架**: [SQLAlchemy](https://www.sqlalchemy.org/) (Async Mode)
- **数据库驱动**: aiomysql
- **数据验证**: [Pydantic](https://docs.pydantic.dev/) V2
- **数据库迁移**: [Alembic](https://alembic.sqlalchemy.org/)
- **包管理**: pip (依赖列表见 `requirements.txt`)

## 2. 项目结构

项目采用模块化分层架构，严禁循环依赖。

```text
omms_backend/
├── app/
│   ├── api/            # 路由层 (Controller) - 处理 HTTP 请求与响应
│   ├── core/           # 核心配置层 - 统一响应等
│   ├── db/             # 数据库层 - 连接会话
│   ├── models/         # 数据模型层 (ORM) - 定义数据库表结构
│   │   ├── __init__.py # Base 声明
│   ├── schemas/        # 数据验证层 (DTO) - 定义请求/响应数据结构
│   ├── server.py       # 应用入口 - 初始化 App、注册路由、中间件
│   └── settings.py     # 环境变量与数据库配置
├── scripts/            # 开发/运维辅助脚本
│   └── init_db.py      # 数据库重建与开发数据初始化
├── .env.example        # 环境变量模板
├── requirements.txt    # 项目依赖
└── README.md           # 项目说明文档
```

数据库结构定义文件：
- 仓库根目录：[`docs/omms.sql`](omms.sql)

## 3. 命名规范

遵循 [PEP 8](https://peps.python.org/pep-0008/) 规范。

- **文件/模块名**: 全小写，下划线分隔 (snake_case)。
  - 正确: `record_service.py`, `user_auth.py`
  - 错误: `RecordService.py`, `userAuth.py`
- **类名**: 大驼峰 (PascalCase)。
  - 正确: `RecordCreate`, `UserResponse`
  - 错误: `record_create`, `user_response`
- **变量/函数名**: 全小写，下划线分隔 (snake_case)。
  - 正确: `get_record_by_id`, `db_session`
  - 错误: `getRecordById`, `DBSession`
- **常量**: 全大写，下划线分隔 (UPPER_CASE)。
  - 正确: `MAX_PAGE_SIZE`, `DEFAULT_TIMEOUT`
- **数据库表名**: 全小写，下划线分隔，通常使用复数。
  - 正确: `medical_records`, `users`
- **URL 路径**: 全小写，连字符分隔 (kebab-case) 或保持简洁的资源名词。
  - 正确: `/api/v1/medical-records`, `/users/{id}/profile`

## 4. 开发流程与规范

### 4.1 数据模型 (Models)

在 `app/models` 目录下定义 SQLAlchemy 模型。
- 必须继承自 `app.db.base.Base`。
- 必须定义 `__tablename__`。
- 字段尽量添加 `comment` 参数（部分数据库支持）。

```python
# app/models/example.py
from sqlalchemy import Column, Integer, String
from app.db.base import Base

class Example(Base):
    __tablename__ = "examples"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False, comment="名称")
```

### 4.2 数据验证 (Schemas)

在 `app/schemas` 目录下定义 Pydantic 模型。这是生成 Swagger 文档的核心。

**关键要求：**
1. **Field 描述**: 所有字段必须使用 `Field(..., description="中文描述")`。
2. **示例数据**: 在 `model_config` 中提供 `examples`，这对于前端对接至关重要。
3. **分离模型**: 区分创建 (`Create`)、更新 (`Update`) 和响应 (`Response`) 模型。

```python
# app/schemas/example.py
from pydantic import BaseModel, Field

class ExampleCreate(BaseModel):
    name: str = Field(..., description="示例名称", max_length=100)
    
    model_config = {
        "json_schema_extra": {
            "examples": [{"name": "测试数据"}]
        }
    }

class ExampleResponse(ExampleCreate):
    id: int = Field(..., description="ID")
    
    model_config = {
        "from_attributes": True  # 允许从 ORM 对象读取数据
    }
```

### 4.3 API 路由 (API)

在 `app/api` 目录下编写路由逻辑。

**关键要求：**
1. **路由装饰器**: 必须包含 `summary` (简短标题), `description` (详细说明), `response_model` (响应结构)。
2. **统一响应**: 必须使用 `app.core.response` 提供的 `success` 和 `fail` 函数包裹返回值。
3. **异步操作**: 数据库操作必须使用 `await`。
4. **依赖注入**: 使用 `Depends(get_session)` 获取数据库会话。

```python
# app/api/examples.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.db.session import get_session
from app.core.response import success
from app.schemas.example import ExampleResponse

router = APIRouter()

@router.get(
    "/examples",
    summary="获取示例列表",
    description="查询所有示例数据。",
    response_model=dict  # 实际返回会被 success 包装，这里也可写具体的 ResponseModel
)
async def list_examples(session: AsyncSession = Depends(get_session)):
    # ... 业务逻辑 ...
    return success(data=result_list)
```

### 4.4 数据库迁移

修改 `app/models` 下的代码后，**必须**生成迁移脚本。

1. 生成迁移脚本:
   ```bash
   alembic revision --autogenerate -m "描述变更内容"
   ```
2. 检查 `alembic/versions` 下生成的脚本是否正确。
3. 应用迁移:
   ```bash
   alembic upgrade head
   ```

## 5. 文档规范 (Swagger UI)

为了保证 `/docs` 页面生成的文档对前端和测试人员友好，请遵循：

1. **Tag 分组**: 在 `app/server.py` 的 `app.openapi_tags` 中注册 Tag，并在 Router 中指定 `tags=["xxx"]`。
2. **中文优先**: Summary, Description, Field Description 均使用中文。
3. **枚举值**: 如果字段是枚举，请在 Pydantic 中使用 `Enum` 类，Swagger 会自动展示可选值。

**如果有相关内容更新，也应该更新相关文档。**

## 6. Git 提交规范

见 [Git 提交消息规范](<Git 提交消息规范.md>)。
