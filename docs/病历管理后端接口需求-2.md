# 病历管理后端接口需求补充（缺失接口）

## 概述

- 目标：补充“病历管理”模块在实际落地中缺失但前端依赖的接口，覆盖筛选扩展、统计数据、词典数据与患者资料查询。
- 风格：与 `/d:/codespace/omms/docs/病历管理后端接口需求.md` 保持一致（统一响应、鉴权、状态码等）。

## 统一响应规范

- 统一包：`{ code: number, message: string, data?: any }`
- 成功：`code=200`；客户端依据 `data` 消费
- 客户端可感知的错误：`400` 参数错误，`404` 资源不存在，`409` 业务冲突，`401/403` 认证或权限不足
- 认证：所有受保护接口需请求头 `Authorization: Bearer <token>`

## 接口详情

### 病历列表筛选扩展

- GET `/api/records`
  - 描述：病历列表查询（扩展筛选能力）
  - 查询参数：
    - `status?: 'draft'|'finalized'|'cancelled'`
    - `patientKeyword?: string`（按患者姓名关键词模糊匹配）
    - `deptId?: number`
    - `doctorId?: number`
    - `hasLab?: boolean`
    - `hasImaging?: boolean`
    - `date?: 'YYYY-MM-DD'`（单日查询）
    - `dateStart?: 'YYYY-MM-DD'`，`dateEnd?: 'YYYY-MM-DD'`（日期范围查询，若与 `date` 同传，以范围优先）
    - `page?: number`，`pageSize?: number`
  - 响应：`{ list: MedicalRecord[], total: number, page: number, pageSize: number }`
  - 说明：`patientKeyword` 与 `dateStart/dateEnd` 为新增字段，用于支持前端的关键词与日期范围筛选需求。

### 病历统计数据

- GET `/api/records/stats`
  - 描述：返回病历的统计数据（支持全量或按日期范围）
  - 查询参数：
    - `date?: 'YYYY-MM-DD'`（统计当日）
    - `dateStart?: 'YYYY-MM-DD'`，`dateEnd?: 'YYYY-MM-DD'`（统计区间）
    - 其他可选：`deptId?: number`，`doctorId?: number`
  - 响应：`{ total: number, draft: number, finalized: number, cancelled: number, withLab: number, withImaging: number }`
  - 说明：用于页面指标卡展示（今日病历、草稿、定稿、作废、含检验/检查）。

### 词典数据（检验/检查项目）

- GET `/api/records/dictionaries`

  - 描述：返回病历录入相关的词典数据集合
  - 响应：`{ imaging: string[], labs: string[] }`
  - 说明：前端使用该词典填充“检查/检验”的选项（替代本地 `mockData`）。

- 可选：分项词典接口
  - GET `/api/records/dictionaries/imaging`
    - 响应：`string[]`
  - GET `/api/records/dictionaries/labs`
    - 响应：`string[]`

### 患者资料查询（用于详情展示）

- GET `/api/patients`

  - 描述：按姓名关键词查询患者基本资料
  - 查询参数：`name: string`（关键词）
  - 响应：`{ list: Patient[], total: number, page: number, pageSize: number }`
  - Patient：`{ patientId: number, userId?: number, name: string, gender?: 0|1, birthday?: string, idCard?: string, address?: string, emergencyContact?: string, emergencyPhone?: string }`
  - 说明：用于列表侧的快速检索与详情补充。

- GET `/api/patients/{id}`
  - 描述：按患者唯一标识获取患者详细资料
  - 响应：`Patient`
  - 说明：病历详情弹窗中展示患者信息时可调用；若病历仅记录了姓名而无 `patientId`，则使用上面的关键词接口。

## 校验与业务约束

- 列表筛选：当同时传入 `date` 与 `dateStart/dateEnd` 时，以日期范围优先；如只传单日则进行单日过滤。
- 统计数据：统计口径需与列表数据源一致（同一查询条件下的聚合结果）。
- 词典数据：
  - 返回值需去重且过滤空值；
  - 建议按后台配置项维护（如医院级词典与科室级扩展）。
- 患者资料：
  - `name` 关键词匹配建议忽略大小写与空格；
  - 返回分页结果以避免长列表。

## 错误码与消息

- `200` 成功
- `400` 参数错误（字段缺失、格式非法、范围不合法）
- `404` 资源不存在（患者/词典项未找到）
- `409` 业务冲突（统计区间过大导致资源耗尽，可根据策略返回）
- `401/403` 认证失败或权限不足

## 安全与权限

- 认证：使用 JWT；受保护路由需携带 `Authorization: Bearer <token>`
- 权限：
  - 统计与列表：医生、护士、前台、管理员均可访问（按角色授权范围过滤）
  - 词典维护：管理员或配置管理员可管理（若提供词典维护后台）
  - 患者资料：仅对有权限的角色开放，必要时对敏感字段脱敏

## 性能与可靠性要求

- 列表与统计查询需支持分页与合理的时间范围限制；默认 `pageSize` 建议 20–50。
- 统计接口应有缓存或预聚合策略（如当日维度），保证 `P95 < 400ms`。
- 词典接口可走缓存层（如 5–10 分钟）以减少数据库读压力。

## 示例载荷

- 病历统计请求：
  - `GET /api/records/stats?dateStart=2025-01-01&dateEnd=2025-01-31&deptId=1`
- 病历统计响应：
  - `{ "code": 200, "message": "success", "data": { "total": 120, "draft": 35, "finalized": 70, "cancelled": 15, "withLab": 60, "withImaging": 40 } }`
- 词典数据响应：
  - `{ "code": 200, "message": "success", "data": { "imaging": ["胸片", "CT", "核磁共振"], "labs": ["血常规", "肝肾功能", "凝血功能"] } }`
- 患者关键词查询请求：
  - `GET /api/patients?name=王`
- 患者关键词查询响应：
  - `{ "code": 200, "message": "success", "data": { "list": [{ "patientId": 10086, "userId": 20001, "name": "王小明", "gender": 1, "birthday": "1995-06-01", "idCard": "4101************", "address": "北京市海淀区...", "emergencyContact": "王先生", "emergencyPhone": "138****8888" }], "total": 1, "page": 1, "pageSize": 20 } }`
