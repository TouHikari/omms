# 病历管理后端接口需求

## 概述

- 目标：为“病历管理”与“病历模板”模块提供稳定、可扩展的后端接口，支撑病历创建、编辑、状态流转与模板化录入的完整流程。
- 依据：当前前端模拟接口与数据结构（参见 `omms_frontend/src/api/record.js`），需后端落地为真实服务。

## 统一响应规范

- 统一包：`{ code: number, message: string, data?: any }`
- 成功：`code=200`；客户端依据 `data` 消费
- 客户端可感知的错误：`400` 参数错误，`404` 资源不存在，`409` 业务冲突，`401/403` 认证或权限不足

## 资源模型

- MedicalRecord（病历）：
  - `{ id: string, patient?: string, department: string, doctor: string, createdAt: 'YYYY-MM-DD HH:mm', status: 'draft'|'finalized'|'cancelled', hasLab?: boolean, hasImaging?: boolean, chiefComplaint?: string, diagnosis?: string, prescriptions?: string[], labs?: string[], imaging?: string[] }`
- RecordTemplate（病历模板）：
  - `{ id: number, name: string, scope: string, fields: string[], defaults: { chiefComplaint?: string, diagnosis?: string, prescriptions?: string[], labs?: string[], imaging?: string[] } }`
- 病历号规范：`MR-YYYYMMDD-XXXX`（四位随机数）

## 接口详情

### 病历管理

- GET `/api/records`
  - 描述：病历列表查询
  - 查询参数：`status?: 'draft'|'finalized'|'cancelled'`，`date?: 'YYYY-MM-DD'`，`deptId?: number`，`doctorId?: number`，`hasLab?: boolean`，`hasImaging?: boolean`，`page?: number`，`pageSize?: number`
  - 响应：`{ list: MedicalRecord[], total: number, page: number, pageSize: number }`
- GET `/api/records/{id}`
  - 描述：获取病历详情
  - 响应：`MedicalRecord`
- POST `/api/records`
  - 描述：创建病历
  - 请求体：`{ deptId: number, doctorId: number, patientId?: number, patientName?: string, time?: 'HH:mm', chiefComplaint?: string, diagnosis?: string, prescriptions?: string[], labs?: string[], imaging?: string[] }`
  - 行为：
    - 生成病历号 `id`（`MR-YYYYMMDD-XXXX`）
    - 计算 `createdAt = YYYY-MM-DD + time`（`time` 未提供时默认 `'10:00'`）
    - 设置初始 `status='draft'`
    - 根据 `labs/imaging` 填充 `hasLab/hasImaging`
  - 校验：
    - `deptId/doctorId` 必填且一致（医生属于科室）
    - `patientId` 建议为唯一标识；若仅有姓名则使用 `patientName` 记录
  - 响应：创建成功的 `MedicalRecord`
- PUT `/api/records/{id}`
  - 描述：更新病历内容
  - 请求体：可更新 `chiefComplaint/diagnosis/prescriptions/labs/imaging/createdAt/doctor/department/patient` 等字段
  - 行为：更新后根据 `labs/imaging` 重新计算 `hasLab/hasImaging`
  - 响应：更新后的 `MedicalRecord`
- PATCH `/api/records/{id}/status`
  - 描述：更新病历状态
  - 请求体：`{ status: 'draft'|'finalized'|'cancelled' }`
  - 约束：
    - 合法状态值；`draft -> finalized|cancelled`；`finalized/cancelled` 不可回到 `draft`
    - 将 `finalized` 前需满足最小内容约束（如需配置：至少填写主诉或诊断）
  - 响应：更新后的 `MedicalRecord`
- 可选：DELETE `/api/records/{id}`
  - 描述：作废病历（与 PATCH 等效，状态置为 `cancelled`），或仅允许软删除
  - 响应：被作废的 `MedicalRecord`

### 病历模板管理

- GET `/api/record-templates`
  - 描述：查询病历模板列表
  - 响应：`RecordTemplate[]`
- GET `/api/record-templates/{id}`
  - 描述：按 ID 获取模板详情
  - 响应：`RecordTemplate`
- POST `/api/record-templates`
  - 描述：创建模板
  - 请求体：`{ name: string, scope?: string, fields?: string[], defaults?: { chiefComplaint?: string, diagnosis?: string, prescriptions?: string[], labs?: string[], imaging?: string[] } }`
  - 校验：`name` 去空格后不可为空；`fields/defaults.*` 若为数组需过滤空值
  - 响应：`RecordTemplate`
- PUT `/api/record-templates/{id}`
  - 描述：更新模板
  - 请求体：同上，允许部分字段更新
  - 行为：对数组字段进行空值过滤与覆盖更新
  - 响应：更新后的 `RecordTemplate`
- DELETE `/api/record-templates/{id}`
  - 描述：删除模板
  - 约束：被引用的模板不可删除（可返回 `409`）
  - 响应：被删除的 `RecordTemplate`

## 校验与业务约束

- 身份校验：建议使用 `patientId` 作为患者唯一标识；若缺失则记录 `patientName`
- 一致性校验：`doctor.deptId === deptId`
- 字段约束：
  - `name/scope` 去空格后不可为空
  - `prescriptions/labs/imaging/fields` 为字符串数组，写入时过滤空值
- 状态机约束：`draft -> finalized|cancelled`；`finalized/cancelled` 不可回退
- 时间约束：`createdAt` 不得晚于当前服务器时间；如允许补录需审计标记
- 审计约束：记录创建/更新/删除的操作者 ID、IP、时间与关键字段快照

## 错误码与消息

- `200` 成功
- `400` 参数错误（字段缺失、格式非法、状态值不合法）
- `404` 资源不存在（病历/模板未找到）
- `409` 业务冲突（删除存在引用的模板、非法状态流转等）
- `401/403` 认证失败或权限不足

## 安全与权限

- 认证：建议使用 JWT；接口置于受保护路由
- 权限：
  - 病历创建与编辑：医生、科室医生；前台可按预约创建草稿
  - 病历状态更新（签署/作废）：医生或具备签署权限的角色
  - 模板管理：管理员或科室主任角色
- 审计：所有关键操作需审计日志与变更快照

## 性能与可靠性要求

- 基线：单实例 `P95 < 400ms`
- 分页：`GET /api/records` 默认分页；`pageSize` 建议 20–50
- 并发：病历编辑建议使用乐观锁或版本号，避免覆盖写
- 指标：暴露各状态占比、科室/医生当日病历量、模板使用频次

## 示例载荷

- 创建病历请求：
  - `{ "deptId": 1, "doctorId": 1, "patientId": 10086, "time": "10:00", "chiefComplaint": "发热伴咳嗽3天", "diagnosis": "上呼吸道感染？", "prescriptions": ["对乙酰氨基酚"], "labs": ["血常规"], "imaging": ["胸片"] }`
- 创建病历响应：
  - `{ "code": 200, "message": "success", "data": { "id": "MR-20250102-1234", "patient": "王小明", "department": "内科", "doctor": "张医生", "createdAt": "2025-01-02 10:00", "status": "draft", "hasLab": true, "hasImaging": true, "chiefComplaint": "发热伴咳嗽3天", "diagnosis": "上呼吸道感染？", "prescriptions": ["对乙酰氨基酚"], "labs": ["血常规"], "imaging": ["胸片"] } }`
- 创建模板请求：
  - `{ "name": "内科常用模板", "scope": "内科", "fields": ["chiefComplaint", "diagnosis", "prescriptions"], "defaults": { "chiefComplaint": "主诉：", "diagnosis": "初步诊断：", "prescriptions": ["口服药物"], "labs": ["血常规"], "imaging": [] } }`
- 创建模板响应：
  - `{ "code": 200, "message": "success", "data": { "id": 3, "name": "内科常用模板", "scope": "内科", "fields": ["chiefComplaint", "diagnosis", "prescriptions"], "defaults": { "chiefComplaint": "主诉：", "diagnosis": "初步诊断：", "prescriptions": ["口服药物"], "labs": ["血常规"], "imaging": [] } } }`
